<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Test API Users (JS)</title>
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                padding: 20px;
            }
            table {
                border-collapse: collapse;
                width: 100%;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }
            th {
                background: #f4f4f4;
            }
        </style>
    </head>
    <body>
        <h1>Test API - Parkings (JS)</h1>
        <p id="status">Chargement des parkings...</p>
        <div id="result"></div>

        <script>
            // Charge les parkings depuis `api/parkings_geojson.php` et affiche un tableau
            async function loadParkings() {
                const status = document.getElementById(
                    "status",
                );
                const result = document.getElementById(
                    "result",
                );
                try {
                    const res = await fetch(
                        "api/parkings_geojson.php",
                    );
                    if (!res.ok) {
                        throw new Error("HTTP " + res.status);
                    }
                    const payload = await res.json();

                    // Support both raw array and GeoJSON FeatureCollection
                    let rows = [];
                    if (
                        payload &&
                        payload.type === "FeatureCollection" &&
                        Array.isArray(payload.features)
                    ) {
                        rows = payload.features.map((f) => {
                            const props = Object.assign(
                                {},
                                f.properties || {},
                            );
                            // expose geometry as lat/lon if present
                            if (
                                f.geometry &&
                                Array.isArray(
                                    f.geometry.coordinates,
                                )
                            ) {
                                const coords =
                                    f.geometry.coordinates; // [lon, lat]
                                props.__lon = coords[0];
                                props.__lat = coords[1];
                            }
                            return props;
                        });
                    } else if (Array.isArray(payload.data)) {
                        rows = payload.data;
                    } else if (Array.isArray(payload)) {
                        rows = payload;
                    }

                    status.textContent = "Résultats : " +
                        (Array.isArray(rows)
                            ? rows.length
                            : 0) +
                        " enregistrements";

                    if (
                        !Array.isArray(rows) ||
                        rows.length === 0
                    ) {
                        result.innerHTML =
                            "<p>Aucun parking trouvé.</p>";
                        return;
                    }

                    // Collect union of keys to build table header
                    const keySet = new Set();
                    rows.forEach((r) =>
                        Object.keys(r || {}).forEach((k) =>
                            keySet.add(k)
                        )
                    );
                    const keys = Array.from(keySet);

                    const table = document.createElement(
                        "table",
                    );
                    const thead = document.createElement(
                        "thead",
                    );
                    const headerRow = document.createElement(
                        "tr",
                    );
                    keys.forEach((k) => {
                        const th = document.createElement("th");
                        th.textContent = k;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement(
                        "tbody",
                    );
                    rows.forEach((r) => {
                        const tr = document.createElement("tr");
                        keys.forEach((k) => {
                            const td = document.createElement(
                                "td",
                            );
                            let v = r[k];
                            if (
                                v === null ||
                                typeof v === "undefined"
                            ) v = "";
                            // pretty-print booleans and numbers
                            td.textContent =
                                (typeof v === "boolean")
                                    ? (v ? "1" : "0")
                                    : String(v);
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);

                    result.innerHTML = "";
                    result.appendChild(table);
                } catch (err) {
                    status.textContent = "Erreur : " +
                        err.message;
                    result.innerHTML = "<pre>" +
                        (err.stack || err) + "</pre>";
                }
            }

            // Démarre
            loadParkings();
        </script>
    </body>
</html>
